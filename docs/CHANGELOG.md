# Changelog

## 2026-02-04
- Remove default Apple Foundation Models instruction text and only use explicit instructions when provided.
- Consolidate LLM prompt templates into five canonical files and drop strict reminder variants.
- Add a disc jockey flag to print before/after intro text during the LLM cleanup pass.
- Move LLM prompt text into editable files under prompts/ with a shared prompt loader.
- Stop rejecting DJ intros that omit the artist name while still requiring the song title.
- Allow DJ intros up to 10 sentences instead of 6.
- Add relaxed intro fallback so TTS can proceed when strict validation rejects all options.
- Tell the LLM to aim for 5-7 sentences when the limit is 10.
- Return None on intro validation failures so retry logic can distinguish intentional rejects.
- Relax song title validation to avoid rejecting intros with different title formatting.
- Fix mixed tab/space indentation in `tts_helpers.py`.
- Add unit tests for `audio_utils`, `llm_wrapper`, `song_details_to_dj_intro`, and `tts_helpers`.
- Broaden DJ intro boilerplate stripping to drop "Ladies and gentlemen, welcome to ..." variants.
- Add a boilerplate stripping test for the "another fantastic hour of music magic" variant.
- Refresh `README.md` and add `docs/INSTALL.md` and `docs/USAGE.md`.
- Add repo-root import setup to `tests/conftest.py` so tests run without PYTHONPATH.
- Tell the LLM to avoid generic welcome openings and tie the first sentence to song details.
- Add boilerplate stripping tests for "another enchanting journey" variants.
- Highlight the `[say]` command output block with `rich` to improve readability.
- Show the filtered intro text once and stop reprinting it in the `[say]` block.
- Reject boilerplate and code-fenced intros during relaxed fallback so retries trigger.
- Tell the LLM to avoid repetitive phrasing in DJ intros.
- Strip code fences from LLM intros and tell the model not to emit markdown fences.
- Add an LLM refine pass to salvage boilerplate or repetitive intros instead of rejecting them.
- Treat invalid or missing <facts> blocks as non-fatal and strip boilerplate instead of rejecting.
- Rephrase LLM prompts to avoid "Do not" phrasing and use positive instructions.
- Replace "without" phrasing in LLM prompts with positive wording.
- Update intro prompt wording to emphasize specific facts and ASCII/ISO 8859-1 punctuation.
- Remove negative phrasing from LLM prompts.
- Update intro opening guidance to emphasize audience engagement.
- Restore "non-repetitive" wording in LLM prompts per preference.
- Tell the LLM to use Wikipedia details only when they clearly match the song metadata.
- Make next-song selector reasons human-readable and keep numeric scores internal.
- Retry next-song selection when the LLM reason is placeholder or score shorthand, requiring runner-up filenames in readable reasons.
- Remove numeric scoring from the next-song selector prompt and add a local fallback reason when the LLM reason is unusable.
- Drop runner-up filenames from next-song selection reasons and simplify reason formatting.
- Add optional live LLM smoke tests for next-song selection and DJ intro generation gated by env vars.
- Require 3-sentence next-song selection reasons and add a 3-sentence fallback reason.
- Add whisper.cpp-based audio transcription module and lyrics injection into DJ intro prompts.
- Skip lyric transcription when `ffmpeg` or `whisper-cli` are missing from PATH.
- Ask for interesting or unique facts in DJ intro prompts and bias intro referee toward those details.
- Expand boilerplate stripping to drop generic "Hey there, Disney fans..." openers.
- Add Brewfile entries for `whisper-cpp` to support lyric transcription.
- Generate temporary WAV files via pygame for playback (stereo) and transcription (mono), without caching.
- Limit lyric text to ASCII with a size cap in prompts, using more aggressive ASCII normalization.
- Avoid whisper-cli Unicode decode crashes by using error-tolerant subprocess decoding.
- Remove the `transcribe_audio.py` shebang since it is not a standalone script.
- Always run a cleanup LLM pass on DJ intros to reduce fluff before validation.
- Require the cleanup LLM to return a <response> block and strip any leading helper text.
- Drop audio resampling and accept the pygame mixer sample rate for temp WAV generation.
- Revert playback to load the original audio file directly instead of temp WAVs.
- Reduce CLI color variety by mapping cyan/magenta to the standard info blue.
- Log raw and sanitized lyric character counts when building DJ intro prompts.
- Refine intro referee reasoning to avoid generic justifications and cite distinctive details.
- Relax cleanup LLM instruction by removing the "output only" constraint on the <response> tag.
- Replace ANSI color codes with rich markup output and escape dynamic text in CLI messages.
- Centralize CLI color tokens in `cli_colors.py` to reduce duplication.
- Log before/after intro stats (chars, words, sentences) for the LLM cleanup pass.
- Ask the cleanup LLM to reduce intro length by about 25 percent.
- Strip generic phrasing from intro referee reasons before printing.
- Remove negative phrasing from the intro referee prompt and replace it with positive guidance.
- Add `docs/PROMPT_COLOR_CATEGORIES.md` to standardize CLI color usage.
- Constrain intro referee to judge only the option text and cite phrases that appear in it.
- Update docs to reference `pip_requirements.txt` after renaming dependencies file.
- Format spoken DJ intro output with borders, indentation, and color in terminal output.
- Use `rich` for DJ intro terminal formatting.
- Add `rich` to `pip_requirements.txt`.
- Render DJ introductions in a double-line Rich panel and print the `[say]` command line without panel styling.
- Fix Wikipedia lookup logging to use shared `Colors` constants after centralizing CLI colors.
- Remove the stray shebang from `audio_wav.py` and replace `audioop` usage with a local channel-conversion helper to satisfy lint checks.
- Map CLI colors to the RGB hex palette and use TEAL for lyric character stats output.
- Expand CLI color usage to cover the full RGB palette (including white) across prompts, external-service logs, and debug lines.
- Add a final LLM cleanup pass after the intro referee selects an option, reusing the existing fluff-reduction prompt.
- Ask the fluff reducer to compress intros and reduce redundant phrasing.

## 2026-02-03
- Replace the wikipedia package with direct API calls and remove the BeautifulSoup dependency.
- Scan music folders recursively so nested audio files are discovered.
- Make TTS intro formatting less aggressive with comma-separated lists.
- Improve next-song choice matching for filenames with track-number prefixes or missing artist prefixes.
- Strip FACT/TRIVIA lines before TTS playback so they are not read aloud.
- Require LLM FACT/TRIVIA lines to be wrapped in <facts> tags and keep only <facts>/<response> output.
- Reject DJ intros that exceed the maximum character limit.
- Add intro validation for sentence count, repetition, and FACT/TRIVIA leakage.
- Limit next-song selection retries and fall back to a random pick to avoid infinite loops.
- Validate <facts> block content and enforce artist/title mentions in intros.
- Log all LLM prompts and responses to output/llm_responses.log.
- Strip the repetitive "Ladies and gentlemen, welcome to the show" opener before TTS.
- Boost TTS output volume by 15 percent to better match song playback.

## 2026-01-15
- Resolve merge markers in `AGENTS.md` and consolidate style and environment notes.
